---
import { getWeather, getLocationByIP, getThemeFromWeather, type WeatherData } from '../lib/weather';

// ÊúçÂä°Á´ØËé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆ
const location = await getLocationByIP();
const weather: WeatherData = await getWeather(location.latitude, location.longitude);
const theme = getThemeFromWeather(weather.type);
---

<div class="weather-station" data-theme={theme}>
  <div class="weather-icon animate-float">
    {weather.icon}
  </div>
  <div class="weather-info">
    <div class="temperature">{weather.temperature}¬∞C</div>
    <div class="description">{weather.description}</div>
  </div>
</div>

<script define:vars={{ theme }}>
  const root = document.documentElement;
  root.setAttribute('data-theme', theme);

  const station = document.querySelector('.weather-station');
  const iconEl = station?.querySelector('.weather-icon');
  const tempEl = station?.querySelector('.temperature');
  const descEl = station?.querySelector('.description');
  const initialDescription = descEl?.textContent ?? '';
  const initialTheme = theme;

  const weatherCodeMap = {
    0: 'sunny',
    1: 'sunny',
    2: 'cloudy',
    3: 'cloudy',
    45: 'cloudy',
    48: 'cloudy',
    51: 'rainy',
    53: 'rainy',
    55: 'rainy',
    61: 'rainy',
    63: 'rainy',
    65: 'rainy',
    66: 'rainy',
    67: 'rainy',
    71: 'cloudy',
    73: 'cloudy',
    75: 'cloudy',
    80: 'rainy',
    81: 'rainy',
    82: 'stormy',
    85: 'cloudy',
    86: 'cloudy',
    95: 'stormy',
    96: 'stormy',
    99: 'stormy',
  };

  const weatherDescriptions = {
    sunny: 'Èò≥ÂÖâÊòéÂ™ö',
    cloudy: 'Â§ö‰∫ëËΩ¨Êô¥',
    rainy: 'ÁªÜÈõ®ÁªµÁªµ',
    stormy: 'È£éÈõ®‰∫§Âä†',
  };

  const weatherIcons = {
    sunny: '‚òÄÔ∏è',
    cloudy: '‚õÖ',
    rainy: 'üåßÔ∏è',
    stormy: '‚õàÔ∏è',
  };

  const getThemeFromWeather = (type) =>
    type === 'sunny' ? 'sunny' : type === 'stormy' || type === 'rainy' ? 'rainy' : 'cloudy';

  const applyTheme = (nextTheme) => {
    root.setAttribute('data-theme', nextTheme);
    station?.setAttribute('data-theme', nextTheme);
  };

  const renderWeather = (weather) => {
    if (iconEl) iconEl.textContent = weather.icon;
    if (tempEl) tempEl.textContent = `${weather.temperature}¬∞C`;
    if (descEl) descEl.textContent = weather.description;
    applyTheme(getThemeFromWeather(weather.type));
  };

  const fetchWeather = async (latitude, longitude) => {
    const response = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&timezone=auto`
    );

    if (!response.ok) {
      throw new Error('Â§©Ê∞îAPIËØ∑Ê±ÇÂ§±Ë¥•');
    }

    const data = await response.json();
    const weatherCode = data.current?.weather_code ?? 0;
    const temperature = data.current?.temperature_2m ?? 20;
    const type = weatherCodeMap[weatherCode] ?? 'sunny';

    return {
      type,
      temperature: Math.round(temperature),
      description: weatherDescriptions[type],
      icon: weatherIcons[type],
    };
  };

  const updateWeatherFromGeolocation = () => {
    if (!navigator.geolocation || !station) return;

    if (descEl) descEl.textContent = 'Ê≠£Âú®ÂÆö‰Ωç...';

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          const weather = await fetchWeather(
            position.coords.latitude,
            position.coords.longitude
          );
          renderWeather(weather);
        } catch {
          if (descEl) descEl.textContent = initialDescription;
          applyTheme(initialTheme);
        }
      },
      () => {
        if (descEl) descEl.textContent = initialDescription;
        applyTheme(initialTheme);
      },
      {
        enableHighAccuracy: false,
        timeout: 8000,
        maximumAge: 10 * 60 * 1000,
      }
    );
  };

  updateWeatherFromGeolocation();
</script>

<style>
  .weather-station {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--surface);
    backdrop-filter: blur(22px);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }

  .weather-station::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(320px circle at 20% 20%, color-mix(in srgb, var(--primary) 35%, transparent), transparent 60%);
    opacity: 0.7;
    pointer-events: none;
  }

  .weather-icon {
    font-size: 3.8rem;
    line-height: 1;
    filter: drop-shadow(0 10px 20px rgba(60, 40, 20, 0.2));
  }

  .weather-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    position: relative;
    z-index: 1;
  }

  .temperature {
    font-size: 2.6rem;
    font-weight: 700;
    font-family: var(--font-display);
    letter-spacing: 0.04em;
    color: var(--primary);
  }

  .description {
    font-size: 1.05rem;
    color: var(--text-muted);
  }
</style>
